!function(e){e.ExtJSManager=function(t){if("object"!=typeof t){var a=arguments[0],r=arguments[1];t={dataService:new e.DataService({adapterName:"OData",serviceName:a,customMetadataUrl:r}),queryOptions:new e.QueryOptions({mergeStrategy:e.MergeStrategy.OverwriteChanges,fetchStrategy:e.FetchStrategy.FromServer}),validationOptions:new e.ValidationOptions({validateOnAttach:!0,validateOnSave:!0,validateOnQuery:!1})}}var n=t.metadataStore||new e.MetadataStore;t.metadataStore=n,n.onCreateModel=function(t){e.CreateExtJSModel(t,!1),e.CreateExtJSModel(t,!0)};var i=new e.EntityManager(t);return i.autoImportEntitiesFromSubContexts=!0,i.associateRecord=function(e){e&&e.save({entityManager:this})},i.entityChanged.subscribe(function(t){var a=t.entityAction,r=t.entity;a==e.EntityAction.RejectChanges&&Ext.isFunction(r.onRejectChanges)&&r.onRejectChanges()}),i},e.CreateExtJSModel=function(e,t){var a=e.namespace+(t?".tree.":".")+e.shortName,r={extend:t?"Ext.data.TreeModel":"Ext.data.Model",autoSync:!0,getReferencesCount:function(){var e=this.raw,t=0;for(var a in e)e[a]instanceof Array&&e[a].length>=1&&(t+=e[a].length);return t},isAdded:function(){var e=this.raw;return e&&null!=e.entityAspect?e.entityAspect.entityState.isAdded():!0},constructor:function(t,a){if(a&&"EntityManager"==a._$typeName){var r=t.entityAspect?t:a.createEntity(e.shortName,t);return this.phantom=r.entityAspect.entityState.isAdded(),this.callParent([r])}return t&&(this.phantom="root"!=t.Id&&(null==t.entityAspect?!0:t.entityAspect.entityState.isAdded())),this.callParent(arguments)},destroy:function(e){e=Ext.apply({records:[this],action:"destroy"},e);var t,a,r,n,i,o,s=this,l=s.phantom!==!0,c=e.scope||s,d=0;return i=new Ext.data.Operation(e),o=function(i){if(n=[s,i],t=Ext.Array.clone(s.stores),i.wasSuccessful()){for(a=t.length;a>d;d++)r=t[d],r.remove?r.remove(s,!0):r.fireEvent("bulkremove",r,[s],[r.indexOf(s)],!1),l&&r.fireEvent("write",r,i);s.clearListeners(),Ext.callback(e.success,c,n)}else Ext.callback(e.failure,c,n);Ext.callback(e.callback,c,n)},s.getProxy().destroy(i,o,s),s},fields:e.dataProperties?e.dataProperties.map(function(e){return{name:e.name,defaultValue:e.isNullable?null:e.dataType.defaultValue,type:e.dataType}}):null,associations:e.navigationProperties?e.navigationProperties.map(function(t){var a=t.entityTypeName.split(":#"),r=a[1]+"."+a[0];return{type:t.isScalar?"hasOne":"hasMany",model:r,primaryKey:e.keyProperties[0].name,foreignKey:t.isScalar?t.foreignKeyNames.length>0?t.foreignKeyNames[0]:null:t.invForeignKeyNames.length>0?t.invForeignKeyNames[0]:null,associatedName:t.name,name:t.name}}):null,idProperty:"Id",proxy:{type:"BreezeData",reader:new Ext.data.reader.Breeze({})}};r.fields=r.fields.concat([{name:"leaf",defaultValue:!0},{name:"text",convert:function(e,t){return t.get("Name")}},{name:"iconCls",convert:function(t,a){return a.iconCls?a.iconCls:"icon_"+e.shortName}}]),decorators&&decorators[e.shortName]&&decorators[e.shortName].decorate(r),r.fields.push({name:"__isAdded",convert:function(e,t){return t.isAdded()}});var n=Ext.define(a,r);return n.prototype.entityType=e,n.entityType=e,n},Ext.override(Ext.data.association.HasOne,{createSetter:function(){var e=this,t=e.foreignKey,a=e.instanceName;return function(e,r,n){var i=e&&e.isModel,o=i?e.getId():e;return i?this[a]=e:this[a]instanceof Ext.data.Model&&!this.isEqual(this.get(t),o)&&delete this[a],this.set(t,o),Ext.isFunction(r)&&(r={callback:r,scope:n||this}),this.raw.entityAspect&&this.raw.entityAspect.entityManager&&(r=r||{},r.entityManager=this.raw.entityAspect.entityManager),Ext.isObject(r)?e.save(r):void 0}},createGetter:function(){var e=this,t=(e.ownerModel,e.associatedName,e.associatedModel,e.foreignKey),a=(e.primaryKey,e.instanceName);return function(r,n){r=r||{};var i,o,s,l=this;l.get(t);if(r.reload===!0||(null==l[a]||null==l[a].raw)&&l.raw&&l.raw[e.associatedName]){var c=null,d=l.raw[e.associatedName];if(!d)return null;var u=Class.resolve(d.entityType.namespace+"."+d.entityType.shortName);return c=new u(d),c.phantom=!1,"function"==typeof r&&(r={callback:r,scope:n||l}),i=r.success,r.success=function(e){l[a]=e,i&&i.apply(this,arguments)},l[a]=c,c}return o=l[a],s=[o],n=n||r.scope||l,Ext.callback(r,n,s),Ext.callback(r.success,n,s),Ext.callback(r.failure,n,s),Ext.callback(r.callback,n,s),o}}}),Ext.override(Ext.data.association.HasMany,{createStore:function(){var e=this,t=e.associatedModel,a=e.storeName,r=e.foreignKey,n=e.primaryKey,i=e.filterProperty,o=e.autoLoad,s=e.storeConfig||{};return function(){var l,c,d,u,p=this,y={};if(void 0===p[a]){if(d=p.get(n),i?c={property:i,value:p.get(i),exactMatch:!0}:p.hasId(d)&&(c={property:r,value:d,exactMatch:!0}),e.orderBy){u=[];for(var f=e.orderBy.split(","),h=0;h<f.length;h++)u.push(f[h])}if(y[r]=p.get(n),l=Ext.apply({},s,{model:t,addRecords:!0,parentModel:p,association:e,filters:c?[c]:void 0,sorters:u?u:void 0,remoteFilter:!1,modelDefaults:y,disableMetaChangeEvent:!0}),e.tree?p[a]=Stratws.data.TreeStore.create(l):p[a]=Stratws.data.Store.create(l),o||p.raw[e.associatedName]&&p.raw[e.associatedName].length>0){var g=e.getReader();g||(proxy=e.associatedModel.getProxy(),g=proxy?proxy.getReader():new Ext.data.reader.Reader({model:e.associatedName})),p[a].add?p[a].loadRecords(g.read(p.raw[e.associatedName]).records):(null==p[a].getRootNode()&&p[a].setRootNode({text:"",leaf:!1,expanded:!1}),p[a].getRootNode().appendChild(g.read(p.raw[e.associatedName]).records),p[a].getRootNode().expand())}}return p[a]}}}),Ext.override(Ext.data.Model,{prepareAssociatedData:function(e,t){var a=this,r=a.associations.items,n=r.length;for(i=0;i<n;i++)association=r[i],associationId=association.associationId,association.tree&&(e[associationId]=1/0);return this.callParent([e,t])}}),Ext.define("Ext.data.proxy.BreezeData",{extend:"Ext.data.proxy.Server",alias:"proxy.BreezeData",alternateClassName:["Ext.data.BreezeData"],config:{queryable:null},doRequest:function(t,a,r){var n=this,i=this.buildRequest(t),o=null==t.locally?!0:t.locally;if("create"==t.action||"update"==t.action){for(var s=[],l=t.getRecords(),c=0;c<l.length;c++){if(l[c].raw&&l[c].raw.entityAspect){if(l[c].raw.entityAspect&&l[c].raw.entityAspect.entityState.isDetached()){if(!t.entityManager)throw new Error("Opera��o de reattachement requerido, mas entityManager n�o informado.");t.entityManager.addEntity(l[c].raw)}}else{if(!t.entityManager)throw new Error("Opera��o de cria��o requerido, mas entityManager n�o informado.");var d=t.entityManager.createEntity(l[c].entityType.shortName,l[c].data);l[c].raw=d,s.push(d)}for(var u in l[c].data)l[c].raw[u]!=l[c].data[u]&&(l[c].data[u]&&l[c].data[u].isModel?l[c].raw[u]=l[c].data[u].raw:l[c].raw[u]=l[c].data[u]);l[c].phantom=!1}return void("create"==t.action?this.processResponse(!0,t,i,s,a,r):a&&a(t))}if("destroy"==t.action){for(var l=t.getRecords(),c=0;c<l.length;c++)l[c].raw&&l[c].raw.entityAspect&&l[c].raw.entityAspect.entityManager&&l[c].raw.entityAspect.setDeleted();return void(a&&a(t))}if("read"==t.action){if(t.node){var p=t.node.get("children");if(p)return p.load({locally:!1,callback:function(e){n.processResponse(!0,t,i,e,a,r)}}),i}var y=t.filters||(r.filters?r.filters.items:null)||[];if(o&&1==y.length&&!y[0].disabled&&"Id"==y[0].property){var d=r.parentModel?r.parentModel.raw:null,f=r.entityManager||(n.queryable?n.queryable.entityManager:d?d.entityAspect.entityManager:null),p=d&&r.association?d[r.association.associatedName]:null,h=(r.model?r.model.entityType:null)||(n.queryable?n.queryable.fromEntityType:p?p.navigationProperty.entityType:null);if(f&&h){var d=f.getEntityByKey(h,y[0].value);if(d)return n.processResponse(!0,t,i,[d],a,r),i}}if(!n.queryable){for(var g=!1,c=0;c<y.length;c++)if(!y[c].disabled&&"data"!=y[c].root){g=!0;break}if(r.parentModel&&r.association){var d=r.parentModel.raw,p=d[r.association.associatedName];if(!p)return n.processResponse(!0,t,i,{inlineCount:0,results:[]},a,r);var s=$.Enumerable.From(p).Where(function(e){return e.entityAspect.entityState.isAdded()}).ToArray(),m=(t.page,t.start),v=t.limit,x=p.parentEntity,E=e.EntityQuery.fromEntityNavigation(p.parentEntity,p.navigationProperty),w=r.association.expands,b=r.association.orderBy,M=r.association.select,S=x.entityAspect.entityManager;if(w&&(E=E.expand(w)),M&&(E=E.select(M)),b&&(E=E.orderBy(b)),null!==p.totalLength&&p.totalLength<p.length&&0==s.length&&(p.totalLength=null),t.ignorePaging)return E=this.buildQueryable(t,E,r),r.association.queryFn&&(E=r.association.queryFn(x,S)),r.association.whereFn&&(E=r.association.whereFn(E)),S.executeQuery(E,function(e){p.totalLength=e.results.length,n.processResponse(!0,t,i,{inlineCount:p.totalLength,results:e.results},a,r)});if(t.addRecords=!1,s.length>=m+v){if(!p.totalLength)return t.start=0,t.limit=0,E=this.buildQueryable(t,E,r),r.association.queryFn&&(E=r.association.queryFn(x,S)),r.association.whereFn&&(E=r.association.whereFn(E)),S.executeQuery(E,function(e){p.totalLength=e.inlineCount,n.processResponse(!0,t,i,{inlineCount:p.totalLength+s.length,results:s.slice(m,m+v)},a,r)});n.processResponse(!0,t,i,{inlineCount:p.totalLength+s.length,results:s.slice(m,m+v)},a,r)}else t.start=t.start-s.length,t.limit=t.limit-s.length%t.limit,E=this.buildQueryable(t,E,r),E.queryOptions=new e.QueryOptions({mergeStrategy:e.MergeStrategy.PreserveChanges}),r.association.queryFn&&(E=r.association.queryFn(x,S)),r.association.whereFn&&(E=r.association.whereFn(E)),S.executeQuery(E,function(e){var o=s.slice(m,m+v),l=$.Enumerable.From(e.results).Where(function(e){return e.entityAspect?!e.entityAspect.entityState.isDeleted():!0}).ToArray();n.processResponse(!0,t,i,{inlineCount:e.inlineCount+s.length,results:o.concat(l)},a,r)},null)}else t.entityManager&&r.prototype.entityType&&t.entityManager.fetchEntityByKey(r.prototype.entityType,t.id,!1).then(function(e){n.processResponse(!0,t,i,[e.entity],a,r)});return i}return n.doRead(i,t,a,r)}return i},buildRequest:function(e){var t,a=this,r=e.params=Ext.apply({},e.params,a.extraParams);return Ext.applyIf(r,a.getParams(e)),void 0!==e.id&&void 0===r[a.idParam]&&(r[a.idParam]=e.id),t=new Ext.data.Request({params:r,action:e.action,records:e.records,operation:e,proxy:a}),e.request=t,t},doRead:function(e,t,a,r){var n=this,i=n.buildQueryable(t,n.getQueryable(),r),o=null;if(!t||t.locally)try{o=i.executeLocally()}catch(s){o=null}return o&&0!=o.length?n.processResponse(!0,t,e,o,a,r):i.execute().then(function(i){(n.hasMapping||n.hasConvert)&&$.each(i.results,function(e,t){$.each(n.model.getFields(),function(e,a){a.mapping?t[a.name]=t[a.mapping]:a.convert&&(t[a.name]=a.convert(i.results,t))})}),n.processResponse(!0,t,e,i,a,r)}).fail(function(i){n.processResponse(!1,t,e,i,a,r)}),e},buildQueryable:function(t,a,r){if(!a)return a;t.noTracking&&(a=a.noTracking());var n=t.select;n&&(a=a.select(n));var i=t.predicates;if(i){for(var o=[],s=0;s<i.length;s++)o.push(e.Predicate.create(i[s].field,i[s].operator||"substringof",i[s].value));a=a.where(e.Predicate.or(o))}var l=this.extraParams;if(l&&l.fields&&l.query){var c=JSON.parse(l.fields),d=l.query,i=[],u=0,p={};if(a.parameters){for(var s=c.length;s>=0;s--)void 0!=a.parameters[c[s]]&&(p[c[s]]="'"+d+"'",u++,c.splice(s,1));u>0&&(a=a.withParameters(p))}if(c.length>0){for(var s=0;s<c.length;s++)i.push(e.Predicate.create(c[s],"substringof",d));a=a.where(e.Predicate.or(i))}}var y=t.params;if(y&&y.node)if(a.parameters&&y.mapping){for(var p=$.extend({},a.parameters),f=0;f<y.mapping.length;f++){var h=y.mapping[f];if(void 0!==a.parameters[h.path]){var d=t.node.raw[h.nodePath]+"";switch(h.type){case"string":p[h.path]="'"+d+"'";break;case"guid":p[h.path]="guid'"+d+"'";break;case"number":default:p[h.path]=d}}}a=a.withParameters(p)}else y.path&&y.node.value&&(a=a.where(y.path,"Equals",y.node.value));if(a.parameters)for(var g in a.parameters)void 0!=y[g]&&(a.parameters[g]=y[g]);var m=t.ignorePaging||!1;if(y&&y.unknownValues)if(a.parameters&&a.parameters.unknownValues){var p=$.extend({},a.parameters);p.unknownValues=y.unknownValues,a=a.withParameters(p),m=!0}else{var v=null;y.unknownValues.split("|").forEach(function(t){v=v?v.or(e.Predicate.create(y.valueField,"eq",t)):e.Predicate.create(y.valueField,"eq",t)}),v&&(a=a.where(v),m=!0)}var x=t.filters||(r.filters?r.filters.items:null);if(x){if(a.parametersByFilters)for(var E=Object.keys(a.parametersByFilters),s=0;s<E.length;s++)a.parameters[E[s]]=a.parametersByFilters[E[s]];a.parametersByFilters={},x.forEach(function(e){if(!e.disabled)if(a.parametersByFilters=a.parametersByFilters||{},a.parametersByFilters[e.property]=a.parameters[e.property],void 0!==a.parameters[e.property])a.parameters[e.property]=e.value,"string"==typeof e.value&&(a.parameters[e.property]="'"+a.parameters[e.property]+"'");else if(e.property&&void 0!==e.value){var t=e.operator||"Equals",r=a.parametersByFilters;a=a.where(e.property,t,e.value),a.parametersByFilters=r}})}var w=t.sorters;if(w&&w.forEach(function(e){var t="ASC"===e.direction?a.orderBy:a.orderByDesc;a=t.call(a,e.property)}),m=null!=r.proxy.enablePaging?!r.proxy.enablePaging:null!=r.association&&null!=r.association.ignorePaging?r.association.ignorePaging:m,!m){a=a.inlineCount(!0);var b=t.page,M=t.limit;b>1&&(a=a.skip((b-1)*M)),((r.association?r.association.pageSize:null)||M)&&(a=a.take((r.association?r.association.pageSize:null)||M))}return a},batch:function(e){var t,a,r,n,i,o,s,l,c,d=this,u=d.batchActions,p=e.entityManager;for(void 0===e.operations&&(e={operations:e,listeners:listeners}),e.batch?Ext.isDefined(e.batch.runOperation)&&(t=Ext.applyIf(e.batch,{proxy:d,listeners:{}})):e.batch={proxy:d,listeners:e.listeners||{}},t||(t=new Ext.data.Batch(e.batch)),t.on("complete",Ext.bind(d.onBatchComplete,d,[e],0)),r=d.batchOrder.split(","),n=r.length,o=0;n>o;o++)if(i=r[o],a=e.operations[i])if(u)t.add(new Ext.data.Operation({entityManager:p,action:i,records:a}));else for(l=a.length,s=0;l>s;s++)c=a[s],t.add(new Ext.data.Operation({entityManager:p,action:i,records:[c]}));return t.start(),t}}),Ext.define("Ext.data.reader.Breeze",{extend:Ext.data.reader.Json,totalProperty:"inlineCount",root:"results",getData:function(e){return e},createAccessor:function(){var e=/[\[\.]/;return function(t){if(Ext.isEmpty(t))return Ext.emptyFn;if(Ext.isFunction(t))return t;if(this.useSimpleAccessors!==!0){var a=String(t).search(e);if(a>=0)return Ext.functionFactory("obj","return obj"+(a>0?".":"")+t)}return function(e){return-1!==t.indexOf("()")?e[t.substring(0,t.length-2)]():e[t]}}}(),extractData:function(e){!e.length&&Ext.isObject(e)&&(e=[k]);for(var t=[],a=0;a<e.length;a++){var r=e[a];if(r.isModel)t.push(r);else{var n=this.model;if(r.entityType&&this.model.prototype.$className.indexOf(r.entityType.namespace)>-1){var i=this.model.prototype.$className.indexOf(".tree.")>-1;n=r.entityType.namespace+(i?".tree.":".")+r.entityType.shortName,t.push(Ext.create(n,r))}else{var o={},s=null;t.push(s=new n(void 0,this.getId(r),r,o)),s.phantom=!1,this.convertRecordData(o,r,s)}}}return t}}),Ext.define("Stratws.data.Store",{extend:Ext.data.Store,constructor:function(e){e=e||{},e.proxy=e.proxy||{type:"BreezeData",queryable:null,reader:new Ext.data.reader.Breeze({})},e.autoSync=null==e.autoSync?!0:e.autoSync,e.remoteFilter=!0,this.callParent([e])},insert:function(e,t){var a,r,n,i,o=this,s=!0,l=o.modelDefaults;if(i=Ext.isIterable(t)?[]:t=[t],r=t.length){for(a=0;r>a;a++)n=t[a],n.isModel||(n=o.createModel(n)),i[a]=n,l&&n.set(l),n.join(o);o.data.insert(e,i),o.snapshot&&o.snapshot.addAll(i),o.requireSort&&(o.suspendEvents(),o.sort(),o.resumeEvents()),o.isGrouped()&&o.updateGroupsOnAdd(i),o.fireEvent("add",o,i,e),o.fireEvent("datachanged",o),o.autoSync&&s&&!o.autoSyncSuspended&&o.sync()}return i},sync:function(e){var t=this,a={},r=t.getNewRecords(),n=t.getUpdatedRecords(),i=t.getRemovedRecords(),o=t.entityManager||(t.parentModel&&t.parentModel.raw&&t.parentModel.raw.entityAspect?t.parentModel.raw.entityAspect.entityManager:null),s=!1;return r.length>0&&(a.create=r,s=!0),n.length>0&&(a.update=n,s=!0),i.length>0&&(a.destroy=i,s=!0),s&&t.fireEvent("beforesync",a)!==!1&&(e=e||{},t.proxy.batch(Ext.apply(e,{entityManager:o,operations:a,listeners:t.getBatchListeners()}))),t},loadPage:function(e,t){return e=0>=e?1:e,this.callParent([e,t])},load:function(e){var t=this;return e="function"==typeof e?{callback:e}:Ext.apply({},e),e.addRecords=null==e.addRecords?!0:e.addRecords,t.callParent([e])}}),Ext.define("Stratws.data.TreeStore",{extend:Ext.data.TreeStore,pageSize:25,currentPage:1,constructor:function(e){e=e||{},e.autoSync=!0,e.proxy=e.proxy||{type:"BreezeData",queryable:null,reader:new Ext.data.reader.Breeze({})},this.callParent([e])},sync:function(e){var t=this,a={},r=t.getNewRecords(),n=t.getUpdatedRecords(),i=t.getRemovedRecords(),o=!1;return r.length>0&&(a.create=r,o=!0),n.length>0&&(a.update=n,o=!0),i.length>0&&(a.destroy=i,o=!0),o&&t.fireEvent("beforesync",a)!==!1&&(e=e||{},t.proxy.batch(Ext.apply(e,{entityManager:t.parentModel&&t.parentModel.raw.entityAspect?t.parentModel.raw.entityAspect.entityManager:null,operations:a,listeners:t.getBatchListeners()}))),t},getCount:function(){return this.getTotalCount()},getTotalCount:function(){return this.proxy.reader.rawData?(this.totalCount=this.proxy.reader.getTotal(this.proxy.reader.rawData),this.totalCount):0},getStore:function(){return this},currentPage:1,clearRemovedOnLoad:!0,clearOnPageLoad:!0,addRecordsOptions:{addRecords:!0},clearFilter:function(){return Stratws.data.Store.prototype.clearFilter.apply(this,arguments)},filter:function(){return Stratws.data.Store.prototype.filter.apply(this,arguments)},loadPage:function(e,t){var a=this;return a.currentPage=e,t=Ext.apply({page:e,start:(e-1)*a.pageSize,limit:a.pageSize,addRecords:!a.clearOnPageLoad},t),a.buffered?a.loadToPrefetch(t):void a.read(t)},nextPage:function(e){this.loadPage(this.currentPage+1,e)},previousPage:function(e){this.loadPage(this.currentPage-1,e)},loadData:function(e,t){var a,r,n=this,i=n.model,o=e.length,s=[];for(a=0;o>a;a++)r=e[a],r.isModel||(r=Ext.ModelManager.create(r,i)),s.push(r);n.loadRecords(s,t?n.addRecordsOptions:void 0)},loadRecords:function(e,t){var a,r,n=this,i=0,o=e.length,s=n.snapshot;if(t&&(a=t.start,r=t.addRecords),r?s&&s.addAll(e):(delete n.snapshot,n.clearData(!0)),n.data.addAll(e),void 0!==a)for(;o>i;i++)e[i].index=a+i,e[i].join(n);else for(;o>i;i++)e[i].join(n);n.suspendEvents(),n.filterOnLoad&&!n.remoteFilter&&n.filter(),n.sortOnLoad&&!n.remoteSort&&n.sort(void 0,void 0,void 0,!0),n.resumeEvents(),n.fireEvent("datachanged",n),n.fireEvent("refresh",n)},clearData:function(e){for(var t=this,a=t.data.items,r=a.length;r--;)a[r].unjoin(t);t.data.clear(),(e!==!0||t.clearRemovedOnLoad)&&(t.removed.length=0)}})}(breeze);